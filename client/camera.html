<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Feed</title>
    <link rel="stylesheet" href="/shared.css">
    <link rel="stylesheet" href="/camera.css">
    <script src="/utils.js"></script>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <img id="photo" alt="Captured photo" />
    <div class="controls">
        <button id="captureBtn" disabled>Take Picture</button>
    </div>
    <div id="status" class="status-message" style="display: none;"></div>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner" aria-hidden="true"></div>
        <span class="loading-text">Saving to Lost &amp; Foundâ€¦</span>
    </div>

    <!-- Result Popup Modal -->
    <div id="resultPopup" class="result-popup" style="display: none;">
        <div class="result-popup-overlay" onclick="closeResultPopup()"></div>
        <div class="result-popup-content">
            <div class="result-popup-card">
                <div class="result-image-wrapper">
                    <img id="resultImage" src="" alt="Captured item" class="result-image" />
                </div>
                <div class="result-content">
                    <div class="result-label" id="resultLabel">Loading...</div>
                    <span class="result-category" id="resultCategory" style="display: none;"></span>
                    <div class="result-details" id="resultDetails"></div>
                </div>
            </div>
            <div class="result-popup-actions">
                <button class="result-popup-button" onclick="closeResultPopup()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const photo = document.getElementById('photo');
        const statusDiv = document.getElementById('status');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const resultPopup = document.getElementById('resultPopup');
        const canvas = document.createElement('canvas');
        let stream = null;
        let statusTimeout = null;

        function showMessage(message, type = 'info', duration = 4000) {
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            if (statusTimeout) {
                clearTimeout(statusTimeout);
            }
            statusTimeout = setTimeout(() => {
                statusDiv.style.display = 'none';
            }, duration);
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loadingOverlay.style.display = 'flex';
                captureBtn.disabled = true;
            } else {
                loadingOverlay.style.display = 'none';
                captureBtn.disabled = false;
            }
        }

        async function startCamera() {
            try {
                // Request camera access
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment' // Use back camera on mobile if available
                    },
                    audio: false
                });

                video.srcObject = stream;
                captureBtn.disabled = false;
                statusDiv.style.display = 'none';
            } catch (error) {
                console.error('Error accessing camera:', error);
                showMessage(`Camera access error: ${error.message}`, 'error', 7000);
                captureBtn.disabled = true;
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            video.srcObject = null;
            captureBtn.disabled = true;
        }

        async function takePicture() {
            if (!stream) {
                await startCamera();
                if (!stream) {
                    return;
                }
            }

            if (video.readyState < 2) {
                await new Promise(resolve => {
                    video.addEventListener('loadeddata', resolve, { once: true });
                });
            }

            const width = video.videoWidth || 1280;
            const height = video.videoHeight || 720;

            canvas.width = width;
            canvas.height = height;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, width, height);

            const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
            photo.src = dataUrl;
            photo.classList.add('visible');
            video.classList.add('hidden');
            showMessage('Photo captured. Uploading...', 'info');
            setLoading(true);

            try {
                await uploadImage(dataUrl);
            } catch (error) {
                // error message already shown in uploadImage
            } finally {
                photo.classList.remove('visible');
                video.classList.remove('hidden');
                setLoading(false);
            }
        }

        async function uploadImage(dataUrl) {
            const formData = new FormData();
            formData.append('imageData', dataUrl);

            try {
                const response = await fetch('/detector/detect', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (jsonError) {
                        console.warn('Could not parse error response JSON:', jsonError);
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (data.warning) {
                    showMessage(data.warning, 'error', 7000);
                }
                
                // Show popup with result if we have metadata
                if (data.success && data.metadata) {
                    showResultPopup(dataUrl, data.metadata);
                } else if (!data.warning) {
                    showMessage('Photo saved to Lost & Found.', 'success');
                }
            } catch (error) {
                console.error('Upload failed:', error);
                showMessage(`Upload failed: ${error.message}`, 'error', 7000);
                throw error;
            }
        }

        // Show result popup with image and metadata
        function showResultPopup(imageDataUrl, metadata) {
            // Set the image
            const resultImage = document.getElementById('resultImage');
            resultImage.src = imageDataUrl;

            // Set the label
            const resultLabel = document.getElementById('resultLabel');
            resultLabel.textContent = formatLabel(metadata.label);

            // Set the category
            const resultCategory = document.getElementById('resultCategory');
            if (metadata.category) {
                resultCategory.textContent = escapeHtml(metadata.category);
                resultCategory.style.display = 'inline-block';
            } else {
                resultCategory.style.display = 'none';
            }

            // Build details HTML
            const resultDetails = document.getElementById('resultDetails');
            let detailsHtml = '';
            detailsHtml += `<p><strong>Time found:</strong> ${formatTimestamp(metadata.timestamp)}</p>`;
            detailsHtml += `<p><strong>Category:</strong> ${escapeHtml(metadata.category)}</p>`;
            detailsHtml += `<p><strong>Color:</strong> ${escapeHtml(metadata.color)}</p>`;
            detailsHtml += `<p><strong>Condition:</strong> ${escapeHtml(metadata.condition)}</p>`;
            detailsHtml += `<p><strong>Features:</strong> ${escapeHtml(metadata.distinctive_features)}</p>`;

            resultDetails.innerHTML = detailsHtml || '<p>No additional details available.</p>';

            // Show popup and prevent body scroll
            resultPopup.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Close result popup
        function closeResultPopup() {
            resultPopup.style.display = 'none';
            document.body.style.overflow = '';
        }

        // Handle keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Close popup on ESC key
            if (e.key === 'Escape' && resultPopup.style.display === 'flex') {
                closeResultPopup();
                return;
            }
            
            // Take picture on Enter key (only when popup is not open and button is not disabled)
            if (e.key === 'Enter' && resultPopup.style.display !== 'flex' && !captureBtn.disabled) {
                e.preventDefault();
                takePicture();
            }
        });

        captureBtn.addEventListener('click', takePicture);

        // Auto-start camera when page loads
        window.addEventListener('load', () => startCamera());

        // Stop camera when page is unloaded
        window.addEventListener('beforeunload', () => stopCamera());
    </script>
</body>
</html>
